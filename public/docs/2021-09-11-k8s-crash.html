<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>k8s 崩溃修复 - Francis Wang's blog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>k8s 崩溃修复 | Francis Wang’s blog</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="k8s 崩溃修复" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="http://next.yanqiw.qianyitian.com/docs/2021-09-11-k8s-crash.html" /> <meta property="og:url" content="http://next.yanqiw.qianyitian.com/docs/2021-09-11-k8s-crash.html" /> <meta property="og:site_name" content="Francis Wang’s blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-09-12T17:32:00+08:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="k8s 崩溃修复" /> <script type="application/ld+json"> {"headline":"k8s 崩溃修复","dateModified":"2021-09-12T17:32:00+08:00","datePublished":"2021-09-12T17:32:00+08:00","url":"http://next.yanqiw.qianyitian.com/docs/2021-09-11-k8s-crash.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://next.yanqiw.qianyitian.com/assets/images/just-the-docs.png"}},"mainEntityOfPage":{"@type":"WebPage","@id":"http://next.yanqiw.qianyitian.com/docs/2021-09-11-k8s-crash.html"},"@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="http://next.yanqiw.qianyitian.com/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="http://next.yanqiw.qianyitian.com/docs/2021-08-01-k8s-cookbook.html" class="nav-list-link">k8s 自制手册</a></li><li class="nav-list-item active"><a href="http://next.yanqiw.qianyitian.com/docs/2021-09-11-k8s-crash.html" class="nav-list-link active">k8s 崩溃修复</a></li><li class="nav-list-item"><a href="http://next.yanqiw.qianyitian.com/docs/2017-05-11-cyq-containerlize-practice.html" class="nav-list-link">餐饮圈后端容器化实践</a></li><li class="nav-list-item"><a href="http://next.yanqiw.qianyitian.com/docs/2016-02-21-schedule-task-in-docker.html" class="nav-list-link">在docker container中启动定时任务</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://next.yanqiw.qianyitian.com/docs/react-native/2016-05-12-react-native-guide.html" class="nav-list-link">React Native入门总结</a><ul class="nav-list "><li class="nav-list-item "><a href="http://next.yanqiw.qianyitian.com/docs/react-native/2016-03-05-use-docker-build-reactjs.html" class="nav-list-link">使用docker创建ReactJS开发环境，实时编译JSX</a></li><li class="nav-list-item "><a href="http://next.yanqiw.qianyitian.com/docs/react-native/2017-03-05-redux-saga.html" class="nav-list-link">Redux Saga实践</a></li><li class="nav-list-item "><a href="http://next.yanqiw.qianyitian.com/docs/react-native/2018-02-11-aliyun-fc-RN-hotpatch-backend.html" class="nav-list-link">阿里函数计算实现简单React Native热更新后台</a></li><li class="nav-list-item "><a href="http://next.yanqiw.qianyitian.com/docs/react-native/2016-10-05-react-native-adopt-to-xcode8.html" class="nav-list-link">React Native 0.27.x adopt to xcode 8</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Francis Wang's blog" aria-label="Search Francis Wang's blog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//www.github.com/yanqiw" class="site-button" > Github </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="k8s-崩溃排查"> <a href="#k8s-崩溃排查" class="anchor-heading" aria-labelledby="k8s-崩溃排查"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> K8S 崩溃排查 </h1> <p>记录一次 K8S 意外崩溃，修复思路，和复盘。</p> <p>集群规格：</p> <div class="table-wrapper"><table> <thead> <tr> <th>节点名</th> <th>规格</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>Master-01</td> <td>2 CPU, 4 GB</td> <td>控制节点（开启允许部署应用）</td> </tr> <tr> <td>Node-01</td> <td>4 CUP, 8 GB</td> <td>运行节点</td> </tr> <tr> <td>Node-02</td> <td>4 CPU, 8 GB</td> <td>运行节点</td> </tr> </tbody> </table></div> <h2 id="安装-ranucher-导致节点内存不足"> <a href="#安装-ranucher-导致节点内存不足" class="anchor-heading" aria-labelledby="安装-ranucher-导致节点内存不足"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 安装 Ranucher 导致节点内存不足 </h2> <p>崩溃起因为，使用 Helm chart 在 K8S 集群上部署 Rancher 。 安装后，初始状态一切正常，可以看到 local 集群，并进行简单管理。20分钟左右，其中一个 node 内存持续飙升， 导致重启。 集群开始调度 pod 到另外一个 node, 导致另外一个 node 内存飙升。出现雪崩效应。 Master 节点 CPU 使用率 100%。整个集群开始不相应任何请求。</p> <h2 id="修复思路"> <a href="#修复思路" class="anchor-heading" aria-labelledby="修复思路"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 修复思路 </h2> <p>因集群上Pod大部分处在内存不足，停止，重启的过程。 无法使用 kubeadmin dashboard 通过 Web 管理集群。仅能通过控制节点上的 kubectl 来链接 K8S，效率低下。所以，先找到一个高效管理的工具， 对集群进行观测。再通过观测结果，做出相应修复方案，并执行。</p> <h3 id="高效的-k8s-终端管理工具---k9s"> <a href="#高效的-k8s-终端管理工具---k9s" class="anchor-heading" aria-labelledby="高效的-k8s-终端管理工具---k9s"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 高效的 K8S 终端管理工具 - K9S </h3> <p><a href="https://k9scli.io/">K9S</a> 是一套运行在命令行内的管理工具，使用习惯于 VIM 类似。通过K9S可以快速查看集群状况，在终端环境下可以高效运维集群。</p> <p><img src="https://k9scli.io/assets/screens/pulses.png" alt="k9s screen" /></p> <p><img src="https://k9scli.io/assets/screens/pods.png" alt="k9s screen" /></p> <h3 id="观测问题"> <a href="#观测问题" class="anchor-heading" aria-labelledby="观测问题"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 观测问题 </h3> <p>在安装 K9S 之后， 通过观测发现 Helm chart 安装的 Rancher，带有全部特性包括多集群管理的 Fleet 特性。因为这些重量级的特性，导致集群内 Node 节点内存始终会被占满，导致重启。 发现了问题，也有了大致的解决问题的方向 —— <strong>将 Rancher 从集群内清除!!!</strong></p> <h4 id="修复方案"> <a href="#修复方案" class="anchor-heading" aria-labelledby="修复方案"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 修复方案 </h4> <p>因为本身集群是用来做实验的测试集群，所以并不要求持续可用。 经过与同事讨论，方案有三个。</p> <h5 id="方案一重置三台虚拟机使用-rke-重新拉起"> <a href="#方案一重置三台虚拟机使用-rke-重新拉起" class="anchor-heading" aria-labelledby="方案一重置三台虚拟机使用-rke-重新拉起"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 方案一：重置三台虚拟机，使用 RKE 重新拉起 </h5> <p>方案简单粗暴。对于临时测试集群来说算是一种一了百了的高效方案。</p> <p>优势：使用 RKE 可以快速拉起一套 K8S 集群，不需要太多多人工干预。同时，可以再体验一下 RKE 管理的K8S。</p> <p>劣势：之前群上的一些应用需要重新安装。例如：ELK 全家桶，Nacos 等等。。。</p> <h5 id="方案二从服务器上产掉k8s通过-kubeadmin-手动拉起"> <a href="#方案二从服务器上产掉k8s通过-kubeadmin-手动拉起" class="anchor-heading" aria-labelledby="方案二从服务器上产掉k8s通过-kubeadmin-手动拉起"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 方案二：从服务器上产掉K8S，通过 Kubeadmin 手动拉起 </h5> <p>方案挑战较多。首先，要清理K8S 的残留文件。其次，手动拉起虽然有脚本支持，但也避免不了一些意外情况。</p> <p>优势：可以演练一下产掉 K8S，重新定制化手动拉起的过程。</p> <p>劣势：周期较长，有因为未清理干净，从而导致再次安装出现意外情况的可能。</p> <h5 id="方案三手动清理-rancher-stack"> <a href="#方案三手动清理-rancher-stack" class="anchor-heading" aria-labelledby="方案三手动清理-rancher-stack"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 方案三：手动清理 Rancher Stack </h5> <p>方案对现有集群影响最小。</p> <p>优势：影响最小，可以通过逐个删除 Rancher Stack 的 Namespace 来完成资源删除。可以演练生产环境时，不能删除集群的情况。</p> <p>劣势：有一些挂掉的 K8S 服务需要重新启动，并关联。</p> <h4 id="选择方案并修复"> <a href="#选择方案并修复" class="anchor-heading" aria-labelledby="选择方案并修复"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 选择方案，并修复 </h4> <p>既然是测试集群，本着折腾的原则。决定先采用__方案三__演练一下生产环境不能删除集群时的灾难恢复。</p> <h5 id="删除-rancher-stack"> <a href="#删除-rancher-stack" class="anchor-heading" aria-labelledby="删除-rancher-stack"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 删除 Rancher Stack </h5> <p>删除过程使用 K9S 非常简单高效。通过，namespece 视图选取相应的 namespace 使用 <code class="language-plaintext highlighter-rouge">ctrl+d</code> 快捷键即可启动删除操作。</p> <h5 id="等待-k8s-自愈"> <a href="#等待-k8s-自愈" class="anchor-heading" aria-labelledby="等待-k8s-自愈"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 等待 K8S 自愈 </h5> <p>因为控制节点仅仅是 CPU 拉满，当 Rancher Stack 被逐渐删除后，控制节点开始恢复运转。 期间，Node-01 因始终无法接到清理指令，一直无法恢复，只能通过阿里云控制台强行重启。</p> <p>最终，所有节点恢复运转，控制节点开始重新调度上层应用。</p> <h5 id="手动恢复操作"> <a href="#手动恢复操作" class="anchor-heading" aria-labelledby="手动恢复操作"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 手动恢复操作 </h5> <p>集群开始运行后，出现了以下问题几个问题。</p> <h6 id="nacos-无法创建-endpoint"> <a href="#nacos-无法创建-endpoint" class="anchor-heading" aria-labelledby="nacos-无法创建-endpoint"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Nacos 无法创建 endpoint </h6> <blockquote> <p>错误信息： the object has been modified; please apply your changes to the latest version and try again</p> <p>经过排查得到官网说明：由于 etcd restore 之后，在重启 kube-apiserver 之前，控制平面各个组件缓存中的 Object 版本跟 etcd 备份中不一致。解决方法是是在 etcd restore 之后，重启控制平面所有组件。</p> </blockquote> <p>通过 k9s 手动重启了所有 kube-system 下的 pod。⚠️注意：要从 pod 视图逐一删除pod。</p> <h6 id="nacos-数据丢失"> <a href="#nacos-数据丢失" class="anchor-heading" aria-labelledby="nacos-数据丢失"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Nacos 数据丢失 </h6> <p>Nacos 重新启动后，之前的数据丢失，手动将本地保存的 Config 和 Namespace 恢复。 这个原因带排查，初步猜测原因是 Node 挂掉后，mysql Pod 被调度到另外一个节点，并重新初始化了数据库。或是，在恢复 Nacos 过程中失误删掉了数据库。</p> <h6 id="手动拉起-kafka"> <a href="#手动拉起-kafka" class="anchor-heading" aria-labelledby="手动拉起-kafka"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 手动拉起 Kafka </h6> <p>集群正常启动后，发现日志没有进去 elasticsearch。 因为，之前 Kafka 是部署在 K8S 集群之外的 Node-01 上。所以，需要手动在 Node-01 上通过 docker-compose 启动。</p> <h5 id="一切恢复"> <a href="#一切恢复" class="anchor-heading" aria-labelledby="一切恢复"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 一切恢复 </h5> <p>经过一番折腾，在没有删除集群的情况下，将服务逐一恢复。历时 6 个小时，如果是真正的线上问题，已经可以定级为__严重故障__。</p> <p>所以，需要复盘一下。</p> <h2 id="复盘"> <a href="#复盘" class="anchor-heading" aria-labelledby="复盘"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 复盘 </h2> <h3 id="关键问题点"> <a href="#关键问题点" class="anchor-heading" aria-labelledby="关键问题点"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 关键问题点 </h3> <ul> <li>在使用 Helm 安装 Rancher 之前，虽然检查过 Pre-requirement，但是对于要求的服务器规格理解不到位。导致没有准确评估出现有集群规格无法满足部署条件。</li> <li>集群再部署前内存水位线已接近临界值，但并没有被注意到。</li> <li>集群挂掉之前，并没有灾备预案。导致恢复过程属于“摸石头过河”。</li> <li>运维自动化程度不够，无论是重新拉起，还是恢复上层应用都需要手动操作。</li> </ul> <h3 id="经验教训"> <a href="#经验教训" class="anchor-heading" aria-labelledby="经验教训"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 经验教训 </h3> <ul> <li>部署前一定要详细了解 Pre-requirement，做好风险分析</li> <li>生产级集群在部署新应用前，要做容量估算和检查，预留好充足资源</li> <li>生产级集群需要有灾备预案，并定期进行演练，以提高运维团队应对突发状况的能力</li> <li>添加自动化运维能力，例如: Ansible, Terraform</li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
